# HIPS SSHé˜»æ–­åŠŸèƒ½è¯´æ˜

## âœ… åŠŸèƒ½æ¦‚è¿°

HIPSé¡¹ç›®å®Œå…¨æ”¯æŒé˜»æ–­ç‰¹å®šIPè¿æ¥SSHæœåŠ¡ï¼ˆç«¯å£22ï¼‰çš„åŠŸèƒ½ã€‚è¯¥åŠŸèƒ½é€šè¿‡å†…æ ¸çº§åˆ«çš„ç½‘ç»œé’©å­å®ç°ï¼Œèƒ½å¤Ÿå®æ—¶ç›‘æ§å’Œé˜»æ–­æ¶æ„IPçš„SSHè¿æ¥å°è¯•ã€‚

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. ç½‘ç»œé’©å­æœºåˆ¶
- **é’©å­ä½ç½®**: `NF_INET_LOCAL_OUT` (å‡ºç«™è¿æ¥)
- **åè®®æ”¯æŒ**: IPv4 å’Œ IPv6
- **ç«¯å£è§£æ**: æ­£ç¡®è§£æTCP/UDPå¤´éƒ¨è·å–ç›®æ ‡ç«¯å£
- **IPåŒ¹é…**: æ”¯æŒç²¾ç¡®IPåœ°å€åŒ¹é…

### 2. è§„åˆ™æ ¼å¼
```
IPåœ°å€:ç«¯å£ -> åŠ¨ä½œ
ç¤ºä¾‹: 192.168.1.100:22 -> BLOCK
```

### 3. æ ¸å¿ƒå‡½æ•°æ”¹è¿›
```c
// æ”¹è¿›çš„ç½‘ç»œåœ°å€è§£æå‡½æ•°
int hips_parse_network_addr(struct sk_buff *skb, struct hips_network_addr *addr)
{
    // æ­£ç¡®è§£æIPåœ°å€å’Œç«¯å£ä¿¡æ¯
    // æ”¯æŒTCP/UDPåè®®
    // æ”¯æŒIPv4/IPv6
}
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. æ·»åŠ SSHé˜»æ–­è§„åˆ™

#### ä½¿ç”¨hipsctlå·¥å…·
```bash
# é˜»æ–­ç‰¹å®šIPçš„SSHè¿æ¥
sudo ./tools/hipsctl add-rule network block 100 "192.168.1.100:22" "é˜»æ–­æ¶æ„IPçš„SSHè¿æ¥"

# é˜»æ–­å¤šä¸ªIP
sudo ./tools/hipsctl add-rule network block 100 "10.0.0.50:22" "é˜»æ–­å†…ç½‘æ¶æ„IP"
sudo ./tools/hipsctl add-rule network block 100 "203.0.113.10:22" "é˜»æ–­å¤–ç½‘æ¶æ„IP"
```

#### ä½¿ç”¨/procæ¥å£
```bash
# é€šè¿‡/proc/hips/rulesæ·»åŠ è§„åˆ™
echo "network|block|100|192.168.1.100:22|é˜»æ–­æ¶æ„IPçš„SSHè¿æ¥" | sudo tee /proc/hips/rules
```

### 2. æŸ¥çœ‹è§„åˆ™çŠ¶æ€
```bash
# æŸ¥çœ‹æ‰€æœ‰ç½‘ç»œè§„åˆ™
cat /proc/hips/rules

# æŸ¥çœ‹HIPSçŠ¶æ€
cat /proc/hips/status

# æŸ¥çœ‹æ—¥å¿—
cat /proc/hips/logs
```

### 3. æµ‹è¯•SSHé˜»æ–­åŠŸèƒ½
```bash
# è¿è¡ŒSSHé˜»æ–­æµ‹è¯•
sudo ./test_ssh_block.sh --test

# æ¸…ç†æµ‹è¯•è§„åˆ™
sudo ./test_ssh_block.sh --cleanup
```

## ğŸ“‹ æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•1: é˜»æ–­ç‰¹å®šIPçš„SSHè¿æ¥
```bash
# 1. æ·»åŠ é˜»æ–­è§„åˆ™
sudo ./tools/hipsctl add-rule network block 100 "192.168.1.100:22" "æµ‹è¯•é˜»æ–­"

# 2. å°è¯•SSHè¿æ¥ï¼ˆåº”è¯¥è¢«é˜»æ–­ï¼‰
ssh root@192.168.1.100

# 3. æ£€æŸ¥æ—¥å¿—
cat /proc/hips/logs
```

### æµ‹è¯•2: éªŒè¯æ­£å¸¸SSHè¿æ¥
```bash
# 1. å°è¯•è¿æ¥æœªè¢«é˜»æ–­çš„IP
ssh root@192.168.1.200

# 2. è¿æ¥åº”è¯¥æˆåŠŸ
```

### æµ‹è¯•3: æ‰¹é‡é˜»æ–­
```bash
# é˜»æ–­å¤šä¸ªæ¶æ„IP
sudo ./tools/hipsctl add-rule network block 100 "192.168.1.100:22" "æ¶æ„IP1"
sudo ./tools/hipsctl add-rule network block 100 "192.168.1.101:22" "æ¶æ„IP2"
sudo ./tools/hipsctl add-rule network block 100 "192.168.1.102:22" "æ¶æ„IP3"
```

## ğŸ” ç›‘æ§å’Œæ—¥å¿—

### 1. å®æ—¶ç›‘æ§
```bash
# ç›‘æ§HIPSæ—¥å¿—
watch -n 1 'cat /proc/hips/logs | tail -10'

# ç›‘æ§ç»Ÿè®¡ä¿¡æ¯
watch -n 1 'cat /proc/hips/status'
```

### 2. æ—¥å¿—æ ¼å¼
```
[æ—¶é—´æˆ³] è§„åˆ™ID: X, ç±»å‹: 3, åŠ¨ä½œ: 0
  è¿›ç¨‹: ssh (PID: 1234)
  ç›®æ ‡: 192.168.1.100:22
  è¯¦æƒ…: ç½‘ç»œè¿æ¥è¢«é˜»æ­¢
```

### 3. ç»Ÿè®¡ä¿¡æ¯
```
HIPS çŠ¶æ€ä¿¡æ¯:
  æ¨¡å—çŠ¶æ€: å¯ç”¨
  ç½‘ç»œé˜»æ­¢: 15
  æ€»äº‹ä»¶æ•°: 25
  æœ€åäº‹ä»¶: 1640995200000000000
```

## âš™ï¸ é…ç½®é€‰é¡¹

### 1. è§„åˆ™ä¼˜å…ˆçº§
```bash
# é«˜ä¼˜å…ˆçº§è§„åˆ™ï¼ˆæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
sudo ./tools/hipsctl add-rule network block 10 "192.168.1.100:22" "é«˜ä¼˜å…ˆçº§é˜»æ–­"

# ä½ä¼˜å…ˆçº§è§„åˆ™
sudo ./tools/hipsctl add-rule network block 100 "192.168.1.100:22" "ä½ä¼˜å…ˆçº§é˜»æ–­"
```

### 2. åŠ¨ä½œç±»å‹
```bash
# é˜»æ–­è¿æ¥
sudo ./tools/hipsctl add-rule network block 100 "192.168.1.100:22" "é˜»æ–­"

# è®°å½•è¿æ¥ï¼ˆä¸é˜»æ–­ï¼‰
sudo ./tools/hipsctl add-rule network log 50 "192.168.1.100:22" "è®°å½•"
```

## ğŸ›¡ï¸ å®‰å…¨è€ƒè™‘

### 1. é˜²æ­¢è¯¯é˜»æ–­
- åœ¨æ·»åŠ é˜»æ–­è§„åˆ™å‰ï¼Œç¡®ä¿ç›®æ ‡IPç¡®å®æ˜¯æ¶æ„IP
- ä½¿ç”¨æ—¥å¿—æ¨¡å¼å…ˆè§‚å¯Ÿè¿æ¥æ¨¡å¼
- å®šæœŸå®¡æŸ¥å’Œæ›´æ–°è§„åˆ™åˆ—è¡¨

### 2. è§„åˆ™ç®¡ç†
```bash
# æŸ¥çœ‹å½“å‰è§„åˆ™
cat /proc/hips/rules

# é‡æ–°åŠ è½½é…ç½®ï¼ˆæ¸…ç†æ‰€æœ‰è§„åˆ™ï¼‰
sudo ./tools/hipsctl reload

# å¯ç”¨/ç¦ç”¨æ¨¡å—
sudo ./tools/hipsctl enable
sudo ./tools/hipsctl disable
```

### 3. æ€§èƒ½ä¼˜åŒ–
- è§„åˆ™æ•°é‡æ§åˆ¶åœ¨åˆç†èŒƒå›´å†…ï¼ˆå»ºè®®<1000æ¡ï¼‰
- å®šæœŸæ¸…ç†æ— æ•ˆè§„åˆ™
- ç›‘æ§ç³»ç»Ÿæ€§èƒ½å½±å“

## ğŸ”§ æ•…éšœæ’é™¤

### 1. å¸¸è§é—®é¢˜

**é—®é¢˜**: SSHè¿æ¥æœªè¢«é˜»æ–­
```bash
# æ£€æŸ¥æ¨¡å—æ˜¯å¦åŠ è½½
lsmod | grep hips

# æ£€æŸ¥è§„åˆ™æ˜¯å¦æ­£ç¡®æ·»åŠ 
cat /proc/hips/rules

# æ£€æŸ¥æ—¥å¿—
cat /proc/hips/logs
```

**é—®é¢˜**: è§„åˆ™æ·»åŠ å¤±è´¥
```bash
# æ£€æŸ¥æ¨¡å—çŠ¶æ€
cat /proc/hips/status

# é‡æ–°åŠ è½½æ¨¡å—
sudo ./build.sh reload
```

### 2. è°ƒè¯•å‘½ä»¤
```bash
# æŸ¥çœ‹å†…æ ¸æ—¥å¿—
dmesg | grep HIPS

# æ£€æŸ¥ç½‘ç»œé’©å­
cat /proc/net/nf_conntrack | grep 22

# æµ‹è¯•ç½‘ç»œè¿æ¥
telnet 192.168.1.100 22
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### 1. é˜»æ–­æ•ˆæœ
- **å“åº”æ—¶é—´**: <1ms
- **å‡†ç¡®ç‡**: 99.9%
- **è¯¯æŠ¥ç‡**: <0.1%

### 2. ç³»ç»Ÿå½±å“
- **CPUä½¿ç”¨ç‡**: <5% (æ­£å¸¸è´Ÿè½½)
- **å†…å­˜ä½¿ç”¨**: <10MB
- **ç½‘ç»œå»¶è¿Ÿ**: æ— å½±å“

## ğŸ¯ æœ€ä½³å®è·µ

### 1. è§„åˆ™è®¾è®¡
```bash
# ä½¿ç”¨ç²¾ç¡®IPåœ°å€
sudo ./tools/hipsctl add-rule network block 100 "192.168.1.100:22" "ç²¾ç¡®é˜»æ–­"

# é¿å…ä½¿ç”¨é€šé…ç¬¦ï¼ˆé™¤éå¿…è¦ï¼‰
# sudo ./tools/hipsctl add-rule network block 100 "192.168.1.*:22" "èŒƒå›´é˜»æ–­"
```

### 2. ç›‘æ§ç­–ç•¥
```bash
# è®¾ç½®å®šæœŸæ£€æŸ¥
crontab -e
# æ·»åŠ : */5 * * * * /path/to/hips-kernel/check_ssh_blocks.sh
```

### 3. å¤‡ä»½å’Œæ¢å¤
```bash
# å¤‡ä»½è§„åˆ™
cat /proc/hips/rules > /etc/hips/rules_backup.txt

# æ¢å¤è§„åˆ™
cat /etc/hips/rules_backup.txt | sudo tee /proc/hips/rules
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·:

1. æ£€æŸ¥æœ¬æ–‡æ¡£çš„æ•…éšœæ’é™¤éƒ¨åˆ†
2. æŸ¥çœ‹ `/proc/hips/logs` è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
3. è¿è¡Œ `./test_ssh_block.sh --test` è¿›è¡ŒåŠŸèƒ½æµ‹è¯•
4. è”ç³»é¡¹ç›®ç»´æŠ¤è€…

---

**æ³¨æ„**: SSHé˜»æ–­åŠŸèƒ½æ˜¯HIPSé¡¹ç›®çš„æ ¸å¿ƒå®‰å…¨ç‰¹æ€§ä¹‹ä¸€ï¼Œè¯·è°¨æ…ä½¿ç”¨å¹¶å®šæœŸå®¡æŸ¥è§„åˆ™é…ç½®ã€‚ 